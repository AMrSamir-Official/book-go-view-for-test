<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book & Go - Price Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            animation: spin 1s linear infinite;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .modal-backdrop.show,
        .modal-content.show {
            display: block;
            opacity: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* Tab Styles */
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="loader" class="flex justify-center items-center h-screen">
        <div class="text-center">
            <div data-lucide="loader-2" class="w-12 h-12 mx-auto text-blue-600 loader"></div>
            <p class="mt-4 text-lg font-semibold text-gray-600">Loading Dashboard...</p>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen flex">
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-40">
                <div class="flex items-center">
                    <i data-lucide="ship" class="w-8 h-8 text-blue-500"></i>
                    <h1 class="text-2xl font-bold ml-2 text-gray-800">Book & Go</h1>
                </div>
                <h2 id="header-title" class="hidden md:block text-xl font-semibold text-gray-700">Program Builder</h2>
                <div class="relative">
                    <button id="account-btn" title="Switch Role"
                        class="rounded-full h-10 w-10 bg-gray-200 flex items-center justify-center text-gray-600 hover:bg-gray-300 transition-colors">
                        <i id="account-icon" data-lucide="user" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
                <div id="admin-panel" class="p-4 md:p-8 space-y-8 hidden">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label for="exchange-rate-input" class="font-semibold text-gray-700">Exchange Rate (1
                                    USD = EGP):</label>
                                <input type="number" step="0.01" id="exchange-rate-input"
                                    class="p-2 border rounded-md w-24">
                            </div>
                            <button id="save-data-btn"
                                class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                                <i data-lucide="save" class="w-5 h-5"></i><span class="ml-2">Save All</span>
                            </button>
                        </div>
                    </div>
                    <div id="admin-programs-section"></div>
                    <hr />
                    <div id="admin-accommodation-section"></div>
                    <hr />
                    <div id="admin-services-section"></div>
                </div>

                <div id="calculator-panel" class="p-4 md:p-8 space-y-8">
                    <div id="current-trip-section"></div>
                    <div id="program-selection-section"></div>
                    <div id="grand-total-section" class="pt-8"></div>
                </div>
            </main>
        </div>
        <div id="toast-container" class="fixed top-20 right-5 z-[1001]"></div>
        <div id="modal-backdrop" class="modal-backdrop"></div>
        <div id="modal-content"
            class="modal-content bg-white rounded-lg shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto custom-scrollbar">
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const LOCAL_STORAGE_KEY = 'bookAndGo_v33_dates';
        const updateChannel = new BroadcastChannel('book_and_go_updates_v33');
        let appData = {};
        let currentTrip = { packages: [] };
        let currentUserRole = 'calculator';
        const genericServiceCategories = ['optionalTours', 'domesticFlights', 'entranceTickets', 'guides', 'transportation'];
        const categoryIcons = {
            nileCruises: 'ship',
            optionalTours: 'camera',
            domesticFlights: 'plane',
            entranceTickets: 'ticket',
            guides: 'user-check',
            transportation: 'bus'
        };

        const defaultData = {
            exchangeRate: 50.0,
            cities: [
                {
                    id: `city_1`, name: 'Cairo', hotels: [
                        {
                            id: `hotel_1`, name: 'Ramses Hilton', rooms: [
                                {
                                    id: `room_1`, name: 'Single', price: 140, currency: 'USD', views: [
                                        { id: `view_1`, name: 'Standard City View', price: 0, currency: 'USD' },
                                        { id: `view_2`, name: 'Deluxe Nile View', price: 30, currency: 'USD' },
                                    ]
                                },
                                { id: `room_2`, name: 'DBL', price: 160, currency: 'USD', views: [] }
                            ]
                        }
                    ]
                },
                { id: `city_2`, name: 'Luxor', hotels: [] }
            ],
            cruiseLines: [
                {
                    id: `cl_1`, name: 'Mayfair Cruises', cruises: [
                        {
                            id: `cruise_1`, name: 'MS Mayfair', rooms: [
                                { id: `c_room_1`, name: 'Standard Cabin', price: 200, currency: 'USD' },
                                { id: `c_room_2`, name: 'Upper Deck Cabin', price: 250, currency: 'USD' }
                            ]
                        }
                    ]
                }
            ],
            services: {
                guides: [{ id: `g_1`, name: 'Expert Egyptologist', cost: 4000, currency: 'EGP' }],
                optionalTours: [], domesticFlights: [], entranceTickets: [], transportation: [],
            },
            programs: [
                {
                    id: 'prog_1',
                    title: 'Cairo Shell Program',
                    description: 'A flexible package for Cairo services.',
                    itinerary: [
                        { day: 1, title: 'Arrival Cairo', description: 'Meet & assist.' },
                        { day: 2, title: 'Pyramids & Museum', description: 'Visit the Great Pyramids & Egyptian Museum.' }
                    ],
                    includes: ['Meet and greet', 'All transfers'],
                    excludes: ['International airfare', 'Optional tours', 'Accommodation'],
                     detailedPricing: [
                        {
                            pax: '1',
                             costs: {
                                meetingAssist: { cost: 50, currency: 'USD' },
                                cairoTransfers: { cost: 40, currency: 'USD' },
                                aswanTransfers: { cost: 0, currency: 'USD' },
                                luxorTransfers: { cost: 0, currency: 'USD' },
                                aswanKomOmboEdfuGuide: { cost: 0, currency: 'USD' },
                                luxorToHurghada: { cost: 0, currency: 'USD' },
                                cairoGuide: { cost: 60, currency: 'USD' },
                                luxorGuide: { cost: 0, currency: 'USD' },
                            },
                            entranceTickets: [
                                { id: 't_1', name: 'Pyramids', cost: 700, currency: 'EGP' },
                                { id: 't_2', name: 'Sakkara', cost: 600, currency: 'EGP' },
                                { id: 't_3', name: 'Egyptian museum', cost: 500, currency: 'EGP' },
                                { id: 't_4', name: 'HIGH DAM', cost: 200, currency: 'EGP' },
                                { id: 't_5', name: 'KOM OMBO', cost: 450, currency: 'EGP' },
                                { id: 't_6', name: 'EDFU', cost: 550, currency: 'EGP' },
                            ]
                        }
                    ]
                }
            ]
        };
        let loader, appContainer, adminPanel, calculatorPanel, headerTitle, accountBtn, modalBackdrop, modalContent;

        // --- DATA MANAGEMENT & UI HELPERS ---
        const loadData = () => {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) return JSON.parse(data);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(defaultData));
            return defaultData;
        };
        const saveData = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
            updateChannel.postMessage('data_updated');
            showToast('All changes saved successfully!', 'success');
        };
        const showToast = (message, type = 'info') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `text-white py-3 px-6 rounded-lg shadow-xl mb-2 transform transition-all duration-300 translate-x-full ${bgColor}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => { toast.classList.add('translate-x-full'); setTimeout(() => toast.remove(), 300); }, 4000);
        };
        const openModal = (htmlContent, size = 'w-1/2') => {
            modalContent.className = `modal-content bg-white rounded-lg shadow-2xl w-11/12 md:${size} max-h-[90vh] overflow-y-auto custom-scrollbar`;
            modalContent.innerHTML = htmlContent;
            modalBackdrop.classList.add('show');
            modalContent.classList.add('show');
            lucide.createIcons();
        };
        const closeModal = () => {
            modalBackdrop.classList.remove('show');
            modalContent.classList.remove('show');
            modalContent.innerHTML = '';
        };
        const getCityById = (cityId) => (appData.cities || []).find(c => c.id === cityId);
        const getHotelByIds = (cityId, hotelId) => {
            const city = getCityById(cityId);
            return city ? city.hotels.find(h => h.id === hotelId) : null;
        };
        const getIndividualServiceById = (category, id) => (appData.services[category] || []).find(s => s.id === id);

        // --- CORE UI SWITCH ---
        const updateDashboardUI = () => {
            if (currentUserRole === 'admin') {
                adminPanel.style.display = 'block';
                calculatorPanel.style.display = 'none';
                headerTitle.textContent = 'Admin Dashboard';
                accountBtn.innerHTML = `<i data-lucide="shield-check" class="w-6 h-6 text-blue-600"></i>`;
                renderAdminPanel();
            } else {
                adminPanel.style.display = 'none';
                calculatorPanel.style.display = 'block';
                headerTitle.textContent = 'Program Builder';
                accountBtn.innerHTML = `<i data-lucide="user" class="w-6 h-6"></i>`;
                renderCalculatorPanel();
            }
            lucide.createIcons();
        };

        // --- ADMIN PANEL RENDER FUNCTIONS ---
        const renderAdminPrograms = () => {
            const container = document.getElementById('admin-programs-section');
            const programsHtml = (appData.programs || []).map((prog, index) => `<div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg"><p class="font-semibold">${prog.title}</p><div class="flex space-x-2"><button data-prog-index="${index}" class="edit-program-btn text-blue-600 hover:text-blue-800"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button><button data-prog-index="${index}" class="delete-program-btn text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div></div>`).join('');
            container.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Program Templates</h2><button id="create-new-program-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 flex items-center"><i data-lucide="plus" class="w-5 h-5"></i><span class="ml-2">Create Program</span></button></div><div class="space-y-2">${programsHtml}</div>`;
        };
        const renderAdminAccommodation = () => {
            const container = document.getElementById('admin-accommodation-section');
            const citiesHtml = (appData.cities || []).map((city, cityIndex) => {
                const hotelsHtml = (city.hotels || []).map((hotel, hotelIndex) => {
                    const roomsHtml = (hotel.rooms || []).map((room, roomIndex) => {
                        const viewsHtml = (room.views || []).map((view, viewIndex) => `<div class="flex items-center gap-2 text-sm ml-8 p-2 bg-gray-100 rounded"><i data-lucide="image" class="w-4 h-4 text-gray-500"></i><span class="flex-1">${view.name} (+${view.price} ${view.currency})</span><button class="text-red-500 hover:text-red-700 remove-view-btn" data-city-index="${cityIndex}" data-hotel-index="${hotelIndex}" data-room-index="${roomIndex}" data-view-index="${viewIndex}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div>`).join('');
                        return `<div class="p-2 border rounded-lg bg-gray-50/50"><div class="flex justify-between items-center"><span class="font-semibold text-sm">${room.name} (${room.price} ${room.currency})</span><button class="text-red-500 hover:text-red-700 remove-room-btn" data-city-index="${cityIndex}" data-hotel-index="${hotelIndex}" data-room-index="${roomIndex}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-2 space-y-1">${viewsHtml}</div><button class="text-xs mt-2 text-blue-600 hover:underline add-view-btn" data-city-index="${cityIndex}" data-hotel-index="${hotelIndex}" data-room-index="${roomIndex}">Add View</button></div>`;
                    }).join('');
                    return `<div class="p-3 border rounded-lg bg-white"><div class="flex justify-between items-center"><span class="font-semibold">${hotel.name}</span><button class="text-red-500 hover:text-red-700 remove-hotel-btn" data-city-index="${cityIndex}" data-hotel-index="${hotelIndex}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-2 space-y-2">${roomsHtml}</div><button class="text-sm mt-2 text-blue-600 hover:underline add-room-btn" data-city-index="${cityIndex}" data-hotel-index="${hotelIndex}">Add Room Type</button></div>`;
                }).join('');
                return `<div class="p-4 border rounded-xl bg-white shadow-lg"><div class="flex justify-between items-center"><h3 class="text-lg font-bold">${city.name}</h3><button class="text-red-500 hover:text-red-700 remove-city-btn" data-city-index="${cityIndex}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-4 space-y-3">${hotelsHtml}</div><button class="mt-4 text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-md hover:bg-blue-200 add-hotel-btn" data-city-index="${cityIndex}">Add Hotel</button></div>`;
            }).join('');
            const cityManagementHtml = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Hotel Management</h2><button id="add-city-btn" class="text-sm bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Add City</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${citiesHtml}</div>`;

            const cruisesHtml = (appData.cruiseLines || []).map((line, lineIndex) => {
                const boatsHtml = (line.cruises || []).map((boat, boatIndex) => {
                    const roomsHtml = (boat.rooms || []).map((room, roomIndex) => `<div class="flex items-center gap-2 text-sm ml-4 p-2 bg-gray-100 rounded"><i data-lucide="bed-double" class="w-4 h-4 text-gray-500"></i><span class="flex-1">${room.name} (${room.price} ${room.currency})</span><button class="text-red-500 hover:text-red-700 remove-cruise-room-btn" data-line-index="${lineIndex}" data-boat-index="${boatIndex}" data-room-index="${roomIndex}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div>`).join('');
                    return `<div class="p-3 border rounded-lg bg-white"><div class="flex justify-between items-center"><span class="font-semibold">${boat.name}</span><button class="text-red-500 hover:text-red-700 remove-cruise-boat-btn" data-line-index="${lineIndex}" data-boat-index="${boatIndex}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-2 space-y-2">${roomsHtml}</div><button class="text-sm mt-2 text-blue-600 hover:underline add-cruise-room-btn" data-line-index="${lineIndex}" data-boat-index="${boatIndex}">Add Cabin Type</button></div>`;
                }).join('');
                return `<div class="p-4 border rounded-xl bg-white shadow-lg"><div class="flex justify-between items-center"><h3 class="text-lg font-bold">${line.name}</h3><button class="text-red-500 hover:text-red-700 remove-cruise-line-btn" data-line-index="${lineIndex}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-4 space-y-3">${boatsHtml}</div><button class="mt-4 text-sm bg-blue-100 text-blue-800 font-semibold py-1 px-3 rounded-md hover:bg-blue-200 add-cruise-boat-btn" data-line-index="${lineIndex}">Add Cruise Boat</button></div>`;
            }).join('');
            const cruiseManagementHtml = `<div class="flex justify-between items-center mb-4 mt-8"><h2 class="text-2xl font-bold text-gray-800">Nile Cruise Management</h2><button id="add-cruise-line-btn" class="text-sm bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Add Cruise Line</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${cruisesHtml}</div>`;

            container.innerHTML = cityManagementHtml + '<hr class="my-8">' + cruiseManagementHtml;
        };
        const renderAdminServices = () => {
            const container = document.getElementById('admin-services-section');
            if (!appData.services) appData.services = {};
            let servicesHtml = '';
            genericServiceCategories.forEach(category => {
                const itemsHtml = (appData.services[category] || []).map((item, index) => `<div class="p-4 bg-gray-50 rounded-lg border"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end"><div class="lg:col-span-2"><label class="text-sm font-medium text-gray-600">Service Name</label><input type="text" value="${item.name}" data-category="${category}" data-index="${index}" data-field="name" class="mt-1 w-full p-2 border rounded-md admin-service-input"></div><div><label class="text-sm font-medium text-gray-600">Cost</label><input type="number" value="${item.cost}" data-category="${category}" data-index="${index}" data-field="cost" class="mt-1 w-full p-2 border rounded-md admin-service-input"></div><div><label class="text-sm font-medium text-gray-600">Currency</label><select data-category="${category}" data-index="${index}" data-field="currency" class="mt-1 w-full p-2 border rounded-md bg-white admin-service-input"><option value="USD" ${item.currency === 'USD' ? 'selected' : ''}>USD</option><option value="EGP" ${item.currency === 'EGP' ? 'selected' : ''}>EGP</option></select></div><div class="flex justify-end"><button data-category="${category}" data-index="${index}" class="remove-service-btn p-2 text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div></div></div>`).join('');
                servicesHtml += `<div class="bg-white p-6 rounded-xl shadow-lg mb-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold capitalize text-gray-700">${category.replace(/([A-Z])/g, ' $1')}</h3><button data-category="${category}" class="add-service-btn text-blue-500 hover:text-blue-700"><i data-lucide="plus-circle" class="w-6 h-6 pointer-events-none"></i></button></div><div class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">${itemsHtml}</div></div>`;
            });
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800">Other Services Prices</h2>${servicesHtml}</div>`;
        };
        const renderAdminPanel = () => {
            document.getElementById('exchange-rate-input').value = appData.exchangeRate || 50;
            renderAdminPrograms();
            renderAdminAccommodation();
            renderAdminServices();
            lucide.createIcons();
        };

        // --- CALCULATOR PANEL RENDER FUNCTIONS ---
        const renderProgramSelection = () => {
            const container = document.getElementById('program-selection-section');
            const programsHtml = (appData.programs || []).map((prog, index) => {
                return `<div class="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transition-all duration-300 hover:shadow-2xl hover:-translate-y-1"><div class="p-5 flex-1"><h3 class="text-lg font-bold text-gray-800">${prog.title}</h3><p class="text-sm text-gray-600 mt-1">${prog.description || ''}</p></div><div class="bg-gray-50 p-3 border-t"><div class="flex justify-between items-center"><button data-prog-index="${index}" class="preview-program-btn text-sm font-semibold text-blue-600 hover:underline">Preview</button><button data-prog-id="${prog.id}" class="add-program-to-trip-btn font-semibold bg-blue-600 text-white py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">Add</button></div></div></div>`;
            }).join('');
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-6">Select a Program</h2><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">${programsHtml}</div>`;
        };
       const renderCurrentTrip = () => {
            const container = document.getElementById('current-trip-section');
            if (currentTrip.packages.length === 0) {
                container.innerHTML = ''; return;
            }
            let html = '<h2 class="text-2xl font-bold text-gray-800 mb-4">Your Current Trip</h2>';
            const rate = parseFloat(appData.exchangeRate) || 50;

            currentTrip.packages.forEach((pkgItem, index) => {
                const program = appData.programs.find(p => p.id === pkgItem.programId);
                if (!program) return;
                const paxOptions = (program.detailedPricing || []).map(tier => `<option value="${tier.pax}" ${pkgItem.paxTier === tier.pax ? 'selected' : ''}>${tier.pax} Person(s)</option>`).join('');
                const subtotal = calculatePackagePrice(pkgItem);

                let accommodationHtml = '<div class="space-y-4">';
                if (!pkgItem.accommodations || pkgItem.accommodations.length === 0) {
                    accommodationHtml += `<p class="text-sm text-gray-500 text-center py-4">No accommodation added yet.</p>`;
                } else {
                    pkgItem.accommodations.forEach((acc, accIndex) => {
                        let accCardHtml = `<div class="p-3 bg-gray-50 rounded-md border space-y-2 relative animate-fadeInUp">
                            <button class="remove-accommodation-leg-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md hover:bg-red-600" data-pkg-index="${index}" data-acc-index="${accIndex}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>`;

                        if (acc.type === 'hotel') {
                            const cityOptions = (appData.cities || []).map(c => `<option value="${c.id}" ${acc.cityId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
                            const hotelOptions = acc.cityId ? (getCityById(acc.cityId)?.hotels || []).map(h => `<option value="${h.id}" ${acc.hotelId === h.id ? 'selected' : ''}>${h.name}</option>`).join('') : '';
                            const roomOptions = acc.hotelId ? (getHotelByIds(acc.cityId, acc.hotelId)?.rooms || []).map(r => `<option value="${r.id}" ${acc.roomId === r.id ? 'selected' : ''}>${r.name} - ${r.price} ${r.currency}</option>`).join('') : '';
                            const viewOptions = acc.roomId ? (getHotelByIds(acc.cityId, acc.hotelId)?.rooms.find(r => r.id === acc.roomId)?.views || []).map(v => `<option value="${v.id}" ${acc.viewId === v.id ? 'selected' : ''}>${v.name} (+ ${v.price} ${v.currency})</option>`).join('') : '';

                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">City</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-city-select"><option value="">Select City...</option>${cityOptions}</select></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">NO. nights</label><input type="number" value="${acc.nights}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-nights-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Check-in</label><input type="date" value="${acc.checkIn || ''}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-checkin-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Check-out</label><input type="date" value="${acc.checkOut || ''}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-checkout-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Hotel</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-hotel-select" ${!acc.cityId ? 'disabled' : ''}><option value="">Select Hotel...</option>${hotelOptions}</select></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Room</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-room-select" ${!acc.hotelId ? 'disabled' : ''}><option value="">Select Room...</option>${roomOptions}</select></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Room type</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-view-select" ${!acc.roomId ? 'disabled' : ''}><option value="">Select View...</option>${viewOptions}</select></div>`;
                        } else if (acc.type === 'cruise') {
                            const cruiseLineOptions = (appData.cruiseLines || []).map(l => `<option value="${l.id}" ${acc.cruiseLineId === l.id ? 'selected' : ''}>${l.name}</option>`).join('');
                            const cruiseOptions = acc.cruiseLineId ? ((appData.cruiseLines || []).find(l => l.id === acc.cruiseLineId)?.cruises || []).map(c => `<option value="${c.id}" ${acc.cruiseId === c.id ? 'selected' : ''}>${c.name}</option>`).join('') : '';
                            const roomOptions = acc.cruiseId ? ((appData.cruiseLines || []).find(l => l.id === acc.cruiseLineId)?.cruises.find(c => c.id === acc.cruiseId)?.rooms || []).map(r => `<option value="${r.id}" ${acc.roomId === r.id ? 'selected' : ''}>${r.name} - ${r.price} ${r.currency}</option>`).join('') : '';

                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Cruise</label><p class="col-span-3 text-sm p-2 bg-white border rounded-md">Nile Cruise</p></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">NO. nights</label><input type="number" value="${acc.nights}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-nights-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Check-in</label><input type="date" value="${acc.checkIn || ''}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-checkin-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Check-out</label><input type="date" value="${acc.checkOut || ''}" data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md text-sm trip-checkout-input"></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Cruise Line</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-cruiseline-select"><option value="">Select Line...</option>${cruiseLineOptions}</select></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Boat</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-cruise-select" ${!acc.cruiseLineId ? 'disabled' : ''}><option value="">Select Boat...</option>${cruiseOptions}</select></div>`;
                            accCardHtml += `<div class="grid grid-cols-5 gap-2 items-center"><label class="text-sm font-semibold text-gray-600 col-span-2">Cabin</label><select data-pkg-index="${index}" data-acc-index="${accIndex}" class="col-span-3 p-2 border rounded-md bg-white text-sm trip-cruiseroom-select" ${!acc.cruiseId ? 'disabled' : ''}><option value="">Select Cabin...</option>${roomOptions}</select></div>`;
                        }
                        accCardHtml += `</div>`;
                        accommodationHtml += accCardHtml;
                    });
                }
                accommodationHtml += `</div><div class="flex gap-2 mt-4"><button class="add-hotel-leg-btn text-sm font-semibold bg-white border border-blue-600 text-blue-600 py-2 px-4 rounded-lg flex-1 hover:bg-blue-50" data-pkg-index="${index}">Add Hotel Stay</button><button class="add-cruise-leg-btn text-sm font-semibold bg-white border border-blue-600 text-blue-600 py-2 px-4 rounded-lg flex-1 hover:bg-blue-50" data-pkg-index="${index}">Add Cruise Stay</button></div>`;

                let individualServicesHtml = `<div class="grid grid-cols-1 gap-2">`;
                if (Object.values(pkgItem.individualItems || {}).flatMap(i => i).length === 0) { individualServicesHtml += `<p class="text-sm text-gray-500 text-center py-4">No additional services added yet.</p>`; }
                else { Object.entries(pkgItem.individualItems || {}).forEach(([category, items]) => { items.forEach((item, itemIndex) => { const service = getIndividualServiceById(category, item.serviceId); if (service) { const priceInUSD = (service.currency === 'EGP' ? service.cost / rate : service.cost) * item.quantity; individualServicesHtml += `<div class="bg-white p-2.5 rounded-lg border flex items-center gap-3 shadow-sm animate-fadeInUp"><i data-lucide="${categoryIcons[category] || 'plus'}" class="w-5 h-5 text-blue-600 flex-shrink-0"></i><div class="flex-1"><p class="font-semibold text-sm text-gray-800">${service.name}</p><p class="text-xs text-gray-500">Quantity: ${item.quantity}</p></div><p class="font-semibold text-sm text-gray-900">${priceInUSD.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p><button data-pkg-index="${index}" data-category="${category}" data-item-index="${itemIndex}" class="remove-individual-from-pkg-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div>`; } }); }); }
                individualServicesHtml += `</div><div class="border-t mt-4 pt-4 space-y-2">`;
                genericServiceCategories.forEach(category => {
                    const optionsHtml = (appData.services[category] || []).map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                    individualServicesHtml += `<div class="flex items-center space-x-2"><select class="flex-1 w-full p-2 border rounded-md bg-white text-sm individual-service-select"><option value="">Add ${category.replace(/([A-Z])/g, ' $1')}...</option>${optionsHtml}</select><input type="number" value="1" min="1" class="p-2 border rounded-md w-20 shadow-inner individual-quantity-input"><button data-pkg-index="${index}" data-category="${category}" class="add-individual-to-pkg-btn bg-green-500 text-white p-2 rounded-lg hover:bg-green-600"><i data-lucide="plus" class="w-5 h-5 pointer-events-none"></i></button></div>`;
                });
                individualServicesHtml += '</div>';

                let itineraryHtml = '<div class="space-y-3">';
                if (program.itinerary && program.itinerary.length > 0 && program.itinerary[0].title) { program.itinerary.forEach(day => { itineraryHtml += `<div class="pb-3 border-b last:border-b-0"><p class="font-bold text-gray-800">Day ${day.day}: ${day.title}</p><p class="text-gray-600 text-sm mt-1">${day.description}</p></div>`; }); }
                else { itineraryHtml += '<p class="text-sm text-gray-500 text-center py-4">No itinerary has been provided.</p>'; }
                itineraryHtml += '</div>';

                html += `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-4 animate-fadeInUp"><div class="flex justify-between items-start"><h3 class="text-xl font-bold text-blue-800">${program.title}</h3><button data-pkg-index="${index}" class="remove-package-from-trip-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-end"><div class="md:col-span-2"><label class="text-sm font-semibold text-gray-600">Travelers</label><select data-pkg-index="${index}" class="w-full mt-1 p-2 border rounded-md bg-white text-sm trip-pax-select"><option value="">Select travelers...</option>${paxOptions}</select></div><div><button data-pkg-index="${index}" class="view-package-details-btn w-full bg-white text-blue-600 font-semibold border border-blue-600 rounded-lg py-2 px-4 hover:bg-blue-50 transition-colors" ${!pkgItem.paxTier ? 'disabled' : ''}>View Base Costs</button></div></div><div class="mt-4 bg-white/60 rounded-lg p-1"><div class="border-b border-gray-300"><nav class="-mb-px flex gap-2" aria-label="Tabs"><button data-pkg-index="${index}" data-tab-toggle="accommodation" class="tab-button active font-semibold py-2 px-4 text-sm rounded-t-md border-b-2 border-transparent hover:text-blue-600 transition-colors">Accommodation</button><button data-pkg-index="${index}" data-tab-toggle="services" class="tab-button font-semibold py-2 px-4 text-sm rounded-t-md border-b-2 border-transparent hover:text-blue-600 transition-colors">Additional Services</button><button data-pkg-index="${index}" data-tab-toggle="itinerary" class="tab-button font-semibold py-2 px-4 text-sm rounded-t-md border-b-2 border-transparent hover:text-blue-600 transition-colors">Itinerary</button></nav></div><div class="p-4 bg-white rounded-b-md"><div data-pkg-index="${index}" data-tab-content="accommodation" class="space-y-3">${accommodationHtml}</div><div data-pkg-index="${index}" data-tab-content="services" class="hidden">${individualServicesHtml}</div><div data-pkg-index="${index}" data-tab-content="itinerary" class="hidden">${itineraryHtml}</div></div></div><div class="mt-4 pt-4 border-t text-right"><p class="font-bold text-lg text-blue-700">Package Subtotal: ${subtotal.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div></div>`;
            });
            container.innerHTML = html;
        };
        const renderGrandTotal = () => {
            const container = document.getElementById('grand-total-section');
            let total = 0;
            currentTrip.packages.forEach(pkgItem => { total += calculatePackagePrice(pkgItem); });
            container.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><div class="text-right"><p class="text-xl font-medium text-gray-600">Grand Total</p><p id="trip-total" class="text-5xl font-bold text-blue-600">${total.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div></div>`;
        };
        const renderCalculatorPanel = () => {
            renderCurrentTrip();
            renderProgramSelection();
            renderGrandTotal();
            lucide.createIcons();
        };

        // --- CALCULATION LOGIC ---
        const calculatePackagePrice = (pkgItem) => {
            const program = appData.programs.find(p => p.id === pkgItem.programId);
            if (!program) return 0;
            const rate = parseFloat(appData.exchangeRate) || 50;
            let totalUSD = 0;
            
            // 1. Calculate base price from detailed pricing
            if(pkgItem.paxTier) {
                const priceTier = (program.detailedPricing || []).find(t => t.pax === pkgItem.paxTier);
                if (priceTier) {
                    // Sum fixed costs
                    if(priceTier.costs){
                        totalUSD += Object.values(priceTier.costs).reduce((sum, item) => {
                            const cost = parseFloat(item.cost) || 0;
                            return sum + (item.currency === 'EGP' ? cost / rate : cost);
                        }, 0);
                    }
                    // Sum entrance tickets
                    if(priceTier.entranceTickets){
                        totalUSD += priceTier.entranceTickets.reduce((sum, item) => {
                             const cost = parseFloat(item.cost) || 0;
                             return sum + (item.currency === 'EGP' ? cost / rate : cost);
                        }, 0);
                    }
                }
            }

            // 2. Calculate accommodation price
            (pkgItem.accommodations || []).forEach(accChoice => {
                let accommodationNightlyRate = 0;
                if (accChoice.type === 'hotel' && accChoice.hotelId && accChoice.roomId) {
                    const hotel = getHotelByIds(accChoice.cityId, accChoice.hotelId);
                    const room = hotel?.rooms.find(r => r.id === accChoice.roomId);
                    if (room) {
                        accommodationNightlyRate += room.currency === 'EGP' ? room.price / rate : room.price;
                        if (accChoice.viewId) {
                            const view = room.views.find(v => v.id === accChoice.viewId);
                            if (view) accommodationNightlyRate += view.currency === 'EGP' ? view.price / rate : view.price;
                        }
                    }
                } else if (accChoice.type === 'cruise' && accChoice.cruiseLineId && accChoice.cruiseId && accChoice.roomId) {
                    const line = (appData.cruiseLines || []).find(l => l.id === accChoice.cruiseLineId);
                    const boat = line?.cruises.find(c => c.id === accChoice.cruiseId);
                    const room = boat?.rooms.find(r => r.id === accChoice.roomId);
                    if (room) { accommodationNightlyRate += room.currency === 'EGP' ? room.price / rate : room.price; }
                }
                totalUSD += accommodationNightlyRate * (accChoice.nights || 0);
            });

            // 3. Calculate additional services
            Object.entries(pkgItem.individualItems || {}).forEach(([category, items]) => {
                items.forEach(item => {
                    const service = getIndividualServiceById(category, item.serviceId);
                    if (service) {
                        const priceInUSD = service.currency === 'EGP' ? service.cost / rate : service.cost;
                        totalUSD += priceInUSD * item.quantity;
                    }
                });
            });
            return totalUSD;
        };

        // --- MODAL & FORM FUNCTIONS ---
        const openProgramDetailsModal = (progIndex) => {
            const program = appData.programs[progIndex];
            if (!program) return;
            const hasItinerary = program.itinerary && program.itinerary.length > 0 && program.itinerary[0].title;
            const itineraryHtml = hasItinerary ? program.itinerary.map(day => `<div class="mb-3 pb-3 border-b last:border-b-0"><p class="font-bold text-gray-800">Day ${day.day}: ${day.title}</p><p class="text-gray-600 text-sm">${day.description}</p></div>`).join('') : '<p class="text-sm text-gray-500">No itinerary provided.</p>';
            const includesHtml = (program.includes || []).map(item => `<li class="text-gray-700">${item}</li>`).join('');
            const excludesHtml = (program.excludes || []).map(item => `<li class="text-gray-700">${item}</li>`).join('');
            const html = `<div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">${program.title}</h2><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="space-y-6"><div><h3 class="text-lg font-semibold text-blue-600 mb-2">Itinerary</h3><div class="pl-2">${itineraryHtml}</div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="text-lg font-semibold text-green-600 mb-2">Includes</h3><ul class="list-disc list-inside space-y-1">${includesHtml}</ul></div><div><h3 class="text-lg font-semibold text-red-600 mb-2">Excludes</h3><ul class="list-disc list-inside space-y-1">${excludesHtml}</ul></div></div></div></div>`;
            openModal(html);
        };
        const openDetailedPricingModal = (pkgItem) => {
            const program = appData.programs.find(p => p.id === pkgItem.programId);
            const priceTier = (program.detailedPricing || []).find(t => t.pax === pkgItem.paxTier);
            if (!priceTier) return;
            
            const rate = parseFloat(appData.exchangeRate) || 50;

            const costs = priceTier.costs || {};
            const costFields = [
                { key: 'meetingAssist', label: 'Meeting and assist cost' },
                { key: 'cairoTransfers', label: 'Cairo transfers' },
                { key: 'aswanTransfers', label: 'Aswan transfers' },
                { key: 'luxorTransfers', label: 'Luxor transfers' },
                { key: 'aswanKomOmboEdfuGuide', label: 'Aswan kom combo edu guide' },
                { key: 'luxorToHurghada', label: 'Luxor to Hurghada' },
                { key: 'cairoGuide', label: 'Cairo guide' },
                { key: 'luxorGuide', label: 'Luxor guide' },
            ];

            let totalCosts = 0;
            const costsHtml = costFields.map(field => {
                const item = costs[field.key] || {cost: 0, currency: 'USD'};
                if(item.cost <= 0) return '';
                const costInUSD = item.currency === 'EGP' ? item.cost / rate : item.cost;
                totalCosts += costInUSD;
                return `
                <tr class="border-b">
                    <td class="py-2 px-4 text-gray-700">${field.label}</td>
                    <td class="py-2 px-4 text-right font-semibold text-gray-900">${costInUSD.toLocaleString('en-US', {style:'currency', currency: 'USD'})}</td>
                </tr>`;
            }).join('');


            let totalTickets = 0;
            const ticketsHtml = (priceTier.entranceTickets || []).map(item => {
                const cost = parseFloat(item.cost) || 0;
                if(cost <= 0) return '';
                const costInUSD = item.currency === 'EGP' ? cost / rate : cost;
                totalTickets += costInUSD;
                return `
                <tr class="border-b">
                    <td class="py-2 px-4 text-gray-700">${item.name}</td>
                    <td class="py-2 px-4 text-right font-semibold text-gray-900">${costInUSD.toLocaleString('en-US', {style:'currency', currency: 'USD'})}</td>
                </tr>`;
            }).join('');

            const html = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">تسعير الباقة المفصل</h2>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="mb-4">
                    <p class="text-gray-600">Base costs for: <span class="font-bold">${program.title}</span></p>
                    <p class="text-gray-600">Travelers: <span class="font-bold">${pkgItem.paxTier} Person(s)</span></p>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-gray-700">Service Costs</h3>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100"><tr><th class="py-2 px-4 text-left font-semibold text-gray-600">Service</th><th class="py-2 px-4 text-right font-semibold text-gray-600">Cost</th></tr></thead>
                                <tbody>${costsHtml}</tbody>
                            </table>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-semibold text-lg mb-2 text-gray-700">Entrance Tickets</h3>
                        <div class="overflow-x-auto rounded-lg border">
                           <table class="w-full text-sm">
                                <thead class="bg-gray-100"><tr><th class="py-2 px-4 text-left font-semibold text-gray-600">Site</th><th class="py-2 px-4 text-right font-semibold text-gray-600">Cost</th></tr></thead>
                                <tbody>${ticketsHtml}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
                 <div class="mt-6 pt-4 border-t text-right">
                    <p class="text-xl font-bold text-gray-800">Total Base Price: <span class="text-blue-600">${(totalCosts + totalTickets).toLocaleString('en-US', {style:'currency', currency: 'USD'})}</span></p>
                 </div>
            </div>`;
            openModal(html, 'w-2/3');
        };
        const openProgramModal = (progIndex = null) => {
            const isEditing = progIndex !== null;
            const defaultTicketsForNew = [
                { id: `t_${Date.now()}_1`, name: 'Pyramids', cost: 0, currency: 'EGP' },
                { id: `t_${Date.now()}_2`, name: 'Sakkara', cost: 0, currency: 'EGP' },
                { id: `t_${Date.now()}_3`, name: 'Egyptian museum', cost: 0, currency: 'EGP' },
                { id: `t_${Date.now()}_4`, name: 'HIGH DAM', cost: 0, currency: 'EGP' },
                { id: `t_${Date.now()}_5`, name: 'KOM OMBO', cost: 0, currency: 'EGP' },
                { id: `t_${Date.now()}_6`, name: 'EDFU', cost: 0, currency: 'EGP' },
            ];

            const program = isEditing 
                ? JSON.parse(JSON.stringify(appData.programs[progIndex])) 
                : { id: `prog_${Date.now()}`, title: '', description: '', itinerary: [{ day: 1, title: '', description: '' }], includes: [''], excludes: [''], detailedPricing: [{ pax: '1', costs:{}, entranceTickets: defaultTicketsForNew }] };
            
            const costFields = [
                { key: 'meetingAssist', label: 'Meeting and assist cost' },
                { key: 'cairoTransfers', label: 'Cairo transfers' },
                { key: 'aswanTransfers', label: 'Aswan transfers' },
                { key: 'luxorTransfers', label: 'Luxor transfers' },
                { key: 'aswanKomOmboEdfuGuide', label: 'Aswan kom combo edu guide' },
                { key: 'luxorToHurghada', label: 'Luxor to Hurghada' },
                { key: 'cairoGuide', label: 'Cairo guide' },
                { key: 'luxorGuide', label: 'Luxor guide' },
            ];

            const renderDetailedPricingAdmin = (pricing) => {
                return (pricing || []).map((tier, tierIndex) => {
                    const tierCosts = tier.costs || {};
                    const costsHtml = costFields.map(field => {
                        const item = tierCosts[field.key] || { cost: 0, currency: 'USD' };
                        return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-center">
                           <label class="font-semibold text-sm text-gray-600">${field.label}</label>
                           <div class="flex gap-2">
                               <input type="number" value="${item.cost}" data-cost-key="${field.key}" data-field="cost" class="w-2/3 p-2 border rounded" placeholder="Cost">
                               <select data-cost-key="${field.key}" data-field="currency" class="w-1/3 p-2 border rounded bg-white">
                                   <option value="USD" ${item.currency === 'USD' ? 'selected' : ''}>USD</option>
                                   <option value="EGP" ${item.currency === 'EGP' ? 'selected' : ''}>EGP</option>
                               </select>
                           </div>
                        </div>`;
                    }).join('<hr class="my-2 md:hidden">');

                    const ticketsHtml = (tier.entranceTickets || []).map((ticket, ticketIndex) => `
                    <tr class="ticket-row">
                        <td class="p-1"><input type="text" value="${ticket.name}" data-field="name" class="w-full p-2 border rounded" placeholder="Site Name"></td>
                        <td class="p-1"><input type="number" value="${ticket.cost}" data-field="cost" class="w-full p-2 border rounded" placeholder="Cost"></td>
                        <td class="p-1"><select data-field="currency" class="w-full p-2 border rounded bg-white"><option value="USD" ${ticket.currency === 'USD' ? 'selected' : ''}>USD</option><option value="EGP" ${ticket.currency === 'EGP' ? 'selected' : ''}>EGP</option></select></td>
                        <td class="p-1 text-center"><button type="button" class="remove-ticket-row-btn text-red-500 hover:text-red-700"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button></td>
                    </tr>`).join('');
                    
                    return `
                    <div class="p-4 border rounded-lg bg-white shadow-sm pricing-tier-group">
                        <div class="flex justify-between items-center mb-3">
                             <div class="flex-1">
                                 <label class="font-semibold text-sm text-gray-600">For Travelers (e.g., 1, 2, 3-5)</label>
                                 <input type="text" value="${tier.pax}" data-field="pax" class="w-full mt-1 p-2 border rounded" placeholder="Pax Range">
                             </div>
                             <button type="button" class="text-red-600 hover:text-red-800 ml-4 remove-pricing-tier-btn" data-tier-index="${tierIndex}"><i data-lucide="x-circle" class="w-6 h-6 pointer-events-none"></i></button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="space-y-2">${costsHtml}</div>
                            <div>
                                <h4 class="font-semibold mb-2 text-gray-700">Entrance Tickets</h4>
                                <table class="w-full text-sm">
                                    <tbody class="tickets-table-body">${ticketsHtml}</tbody>
                                </table>
                                <button type="button" class="text-sm mt-2 text-blue-600 hover:underline add-ticket-row-btn" data-tier-index="${tierIndex}">+ Add New Ticket</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            };

            const renderDynamicList = (items, listName) => (items || []).map((item) => `<div class="flex gap-2 mb-2"><input value="${item}" class="w-full p-2 border rounded dynamic-list-input" data-list="${listName}"><button type="button" class="text-red-500 remove-dynamic-list-item"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('');
            const renderItinerary = (items) => (items || []).map((item, index) => `<div class="p-3 bg-gray-100 rounded-md mb-2"><div class="flex justify-between items-center mb-2"><p class="font-semibold">Day ${index + 1}</p><button type="button" data-index="${index}" class="remove-itinerary-item-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><input type="text" value="${item.title}" data-index="${index}" data-field="title" class="w-full p-2 border rounded-md mb-2 itinerary-input" placeholder="Day Title"><textarea data-index="${index}" data-field="description" class="w-full p-2 border rounded-md itinerary-input" rows="2" placeholder="Day Description">${item.description}</textarea></div>`).join('');
            const html = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${isEditing ? 'Edit' : 'Create'} Program</h2><button type="button" id="close-modal-btn"><i data-lucide="x"></i></button></div>
                <div class="space-y-4">
                    <div><label class="font-semibold">Title</label><input id="program-title" type="text" value="${program.title}" class="w-full p-2 border rounded mt-1"></div>
                    <div><label class="font-semibold">Description</label><textarea id="program-description" class="w-full p-2 border rounded mt-1">${program.description || ''}</textarea></div>
                    <hr/>
                    <div><h3 class="font-bold text-lg text-gray-800">تسعير الباقة المفصل (for base services)</h3><div id="detailed-pricing-list" class="space-y-4 mt-2 bg-gray-100 p-4 rounded-lg">${renderDetailedPricingAdmin(program.detailedPricing)}</div><button type="button" id="add-pricing-tier-btn" class="text-sm mt-3 font-semibold bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">+ Add New Person Group</button></div>
                    <hr/>
                    <div><h3 class="font-semibold">Itinerary</h3><div id="itinerary-list" class="space-y-2 mt-1">${renderItinerary(program.itinerary)}</div><button type="button" id="add-itinerary-item-btn" class="text-sm mt-2 text-blue-600 hover:underline">Add Day</button></div>
                    <div><h3 class="font-semibold">Includes</h3><div id="includes-list" class="space-y-2 mt-1">${renderDynamicList(program.includes, "includes")}</div><button type="button" class="text-sm mt-2 text-blue-600 hover:underline add-dynamic-list-item" data-list="includes">Add Include</button></div>
                    <div><h3 class="font-semibold">Excludes</h3><div id="excludes-list" class="space-y-2 mt-1">${renderDynamicList(program.excludes, "excludes")}</div><button type="button" class="text-sm mt-2 text-blue-600 hover:underline add-dynamic-list-item" data-list="excludes">Add Exclude</button></div>
                </div>
                <div class="mt-6 flex justify-end"><button type="button" id="save-program-btn" data-prog-index="${isEditing ? progIndex : ''}" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg">Save Program</button></div>
            </div>`;
            openModal(html, 'w-2/3');
        };

        // --- EVENT LISTENERS ---
        const initListeners = () => {
            accountBtn.addEventListener('click', () => { currentUserRole = currentUserRole === 'admin' ? 'calculator' : 'admin'; updateDashboardUI(); });
            document.getElementById('save-data-btn').addEventListener('click', saveData);
            document.body.addEventListener('click', e => {
                const target = e.target.closest('button'); if (!target) return;
                if (target.classList.contains('tab-button')) { const { pkgIndex, tabToggle } = target.dataset; const pkgContainer = target.closest('.animate-fadeInUp'); pkgContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); pkgContainer.querySelectorAll('[data-tab-content]').forEach(content => content.classList.add('hidden')); target.classList.add('active'); pkgContainer.querySelector(`[data-tab-content="${tabToggle}"]`).classList.remove('hidden'); }
                if (target.id === 'create-new-program-btn') openProgramModal();
                if (target.classList.contains('edit-program-btn')) openProgramModal(target.dataset.progIndex);
                if (target.classList.contains('delete-program-btn')) { if (confirm('Are you sure?')) { appData.programs.splice(target.dataset.progIndex, 1); renderAdminPrograms(); } }
                if (target.id === 'add-city-btn') { const name = prompt('Enter city name:'); if (name) { if (!appData.cities) appData.cities = []; appData.cities.push({ id: `city_${Date.now()}`, name, hotels: [] }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-city-btn')) { if (confirm('Are you sure?')) { appData.cities.splice(target.dataset.cityIndex, 1); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('add-hotel-btn')) { const name = prompt('Enter hotel name:'); const { cityIndex } = target.dataset; if (name) { if (!appData.cities[cityIndex].hotels) appData.cities[cityIndex].hotels = []; appData.cities[cityIndex].hotels.push({ id: `hotel_${Date.now()}`, name, rooms: [] }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-hotel-btn')) { if (confirm('Are you sure?')) { const { cityIndex, hotelIndex } = target.dataset; appData.cities[cityIndex].hotels.splice(hotelIndex, 1); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('add-room-btn')) { const name = prompt('Enter Room Type name (e.g., Single, DBL):'); const price = parseFloat(prompt('Enter base price:')); const currency = prompt('Enter currency (USD or EGP):', 'USD').toUpperCase(); const { cityIndex, hotelIndex } = target.dataset; if (name && !isNaN(price) && ['USD', 'EGP'].includes(currency)) { if (!appData.cities[cityIndex].hotels[hotelIndex].rooms) appData.cities[cityIndex].hotels[hotelIndex].rooms = []; appData.cities[cityIndex].hotels[hotelIndex].rooms.push({ id: `room_${Date.now()}`, name, price, currency, views: [] }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-room-btn')) { const { cityIndex, hotelIndex, roomIndex } = target.dataset; appData.cities[cityIndex].hotels[hotelIndex].rooms.splice(roomIndex, 1); renderAdminAccommodation(); lucide.createIcons(); }
                if (target.classList.contains('add-view-btn')) { const name = prompt('Enter View name (e.g., City View):'); const price = parseFloat(prompt('Enter additional price for this view:')); const currency = prompt('Enter currency (USD or EGP):', 'USD').toUpperCase(); const { cityIndex, hotelIndex, roomIndex } = target.dataset; if (name && !isNaN(price) && ['USD', 'EGP'].includes(currency)) { if (!appData.cities[cityIndex].hotels[hotelIndex].rooms[roomIndex].views) appData.cities[cityIndex].hotels[hotelIndex].rooms[roomIndex].views = []; appData.cities[cityIndex].hotels[hotelIndex].rooms[roomIndex].views.push({ id: `view_${Date.now()}`, name, price, currency }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-view-btn')) { const { cityIndex, hotelIndex, roomIndex, viewIndex } = target.dataset; appData.cities[cityIndex].hotels[hotelIndex].rooms[roomIndex].views.splice(viewIndex, 1); renderAdminAccommodation(); lucide.createIcons(); }
                if (target.id === 'add-cruise-line-btn') { const name = prompt('Enter Cruise Line name:'); if (name) { if (!appData.cruiseLines) appData.cruiseLines = []; appData.cruiseLines.push({ id: `cl_${Date.now()}`, name, cruises: [] }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-cruise-line-btn')) { if (confirm('Are you sure?')) { appData.cruiseLines.splice(target.dataset.lineIndex, 1); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('add-cruise-boat-btn')) { const name = prompt('Enter Cruise Boat name:'); const { lineIndex } = target.dataset; if (name) { if (!appData.cruiseLines[lineIndex].cruises) appData.cruiseLines[lineIndex].cruises = []; appData.cruiseLines[lineIndex].cruises.push({ id: `cruise_${Date.now()}`, name, rooms: [] }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-cruise-boat-btn')) { const { lineIndex, boatIndex } = target.dataset; appData.cruiseLines[lineIndex].cruises.splice(boatIndex, 1); renderAdminAccommodation(); lucide.createIcons(); }
                if (target.classList.contains('add-cruise-room-btn')) { const name = prompt('Enter Cabin Type name:'); const price = parseFloat(prompt('Enter price:')); const currency = prompt('Enter currency (USD or EGP):', 'USD').toUpperCase(); const { lineIndex, boatIndex } = target.dataset; if (name && !isNaN(price) && ['USD', 'EGP'].includes(currency)) { if (!appData.cruiseLines[lineIndex].cruises[boatIndex].rooms) appData.cruiseLines[lineIndex].cruises[boatIndex].rooms = []; appData.cruiseLines[lineIndex].cruises[boatIndex].rooms.push({ id: `c_room_${Date.now()}`, name, price, currency }); renderAdminAccommodation(); lucide.createIcons(); } }
                if (target.classList.contains('remove-cruise-room-btn')) { const { lineIndex, boatIndex, roomIndex } = target.dataset; appData.cruiseLines[lineIndex].cruises[boatIndex].rooms.splice(roomIndex, 1); renderAdminAccommodation(); lucide.createIcons(); }
                if (target.classList.contains('add-service-btn')) { const category = target.dataset.category; if (!appData.services[category]) appData.services[category] = []; appData.services[category].push({ id: `service_${Date.now()}`, name: 'New Service', cost: 0, currency: 'USD' }); renderAdminServices(); lucide.createIcons(); }
                if (target.classList.contains('remove-service-btn')) { const { category, index } = target.dataset; appData.services[category].splice(index, 1); renderAdminServices(); lucide.createIcons(); }
                if (target.id === 'add-pricing-tier-btn') {
                    const list = document.getElementById('detailed-pricing-list');
                    const tierIndex = list.children.length;
                    const costFields = [ { key: 'meetingAssist', label: 'Meeting and assist cost' }, { key: 'cairoTransfers', label: 'Cairo transfers' }, { key: 'aswanTransfers', label: 'Aswan transfers' }, { key: 'luxorTransfers', label: 'Luxor transfers' }, { key: 'aswanKomOmboEdfuGuide', label: 'Aswan kom combo edu guide' }, { key: 'luxorToHurghada', label: 'Luxor to Hurghada' }, { key: 'cairoGuide', label: 'Cairo guide' }, { key: 'luxorGuide', label: 'Luxor guide' }, ];
                    const costsHtml = costFields.map(field => ` <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-center"> <label class="font-semibold text-sm text-gray-600">${field.label}</label> <div class="flex gap-2"> <input type="number" value="0" data-cost-key="${field.key}" data-field="cost" class="w-2/3 p-2 border rounded" placeholder="Cost"> <select data-cost-key="${field.key}" data-field="currency" class="w-1/3 p-2 border rounded bg-white"> <option value="USD">USD</option> <option value="EGP" selected>EGP</option> </select> </div> </div>`).join('<hr class="my-2 md:hidden">');
                    const defaultTickets = ['Pyramids', 'Sakkara', 'Egyptian museum', 'HIGH DAM', 'KOM OMBO', 'EDFU'];
                    const ticketsHtml = defaultTickets.map(name => `<tr class="ticket-row"><td class="p-1"><input type="text" value="${name}" data-field="name" class="w-full p-2 border rounded" placeholder="Site Name"></td><td class="p-1"><input type="number" value="0" data-field="cost" class="w-full p-2 border rounded" placeholder="Cost"></td><td class="p-1"><select data-field="currency" class="w-full p-2 border rounded bg-white"><option value="USD">USD</option><option value="EGP" selected>EGP</option></select></td><td class="p-1 text-center"><button type="button" class="remove-ticket-row-btn text-red-500 hover:text-red-700"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button></td></tr>`).join('');
                    const newTierHtml = `<div class="p-4 border rounded-lg bg-white shadow-sm pricing-tier-group"> <div class="flex justify-between items-center mb-3"> <div class="flex-1"> <label class="font-semibold text-sm text-gray-600">For Travelers (e.g., 1, 2, 3-5)</label> <input type="text" value="" data-field="pax" class="w-full mt-1 p-2 border rounded" placeholder="Pax Range"> </div> <button type="button" class="text-red-600 hover:text-red-800 ml-4 remove-pricing-tier-btn" data-tier-index="${tierIndex}"><i data-lucide="x-circle" class="w-6 h-6 pointer-events-none"></i></button> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"> <div class="space-y-2">${costsHtml}</div> <div> <h4 class="font-semibold mb-2 text-gray-700">Entrance Tickets</h4> <table class="w-full text-sm"> <tbody class="tickets-table-body">${ticketsHtml}</tbody> </table> <button type="button" class="text-sm mt-2 text-blue-600 hover:underline add-ticket-row-btn" data-tier-index="${tierIndex}">+ Add New Ticket</button> </div> </div> </div>`;
                    list.insertAdjacentHTML('beforeend', newTierHtml);
                    lucide.createIcons();
                }
                if(target.classList.contains('remove-pricing-tier-btn')) { target.closest('.pricing-tier-group').remove(); }
                if(target.classList.contains('add-ticket-row-btn')) { const tbody = target.previousElementSibling.querySelector('.tickets-table-body'); const newRow = `<tr class="ticket-row"><td class="p-1"><input type="text" value="" data-field="name" class="w-full p-2 border rounded" placeholder="Site Name"></td><td class="p-1"><input type="number" value="0" data-field="cost" class="w-full p-2 border rounded" placeholder="Cost"></td><td class="p-1"><select data-field="currency" class="w-full p-2 border rounded bg-white"><option value="USD">USD</option><option value="EGP" selected>EGP</option></select></td><td class="p-1 text-center"><button type="button" class="remove-ticket-row-btn text-red-500 hover:text-red-700"><i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i></button></td></tr>`; tbody.insertAdjacentHTML('beforeend', newRow); lucide.createIcons(); }
                if(target.classList.contains('remove-ticket-row-btn')) { target.closest('.ticket-row').remove(); }
                if (target.classList.contains('add-dynamic-list-item')) { document.getElementById(`${target.dataset.list}-list`).insertAdjacentHTML('beforeend', `<div class="flex gap-2 mb-2"><input value="" class="w-full p-2 border rounded dynamic-list-input" data-list="${target.dataset.list}"><button type="button" class="text-red-500 remove-dynamic-list-item"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`); lucide.createIcons(); }
                if (target.classList.contains('remove-dynamic-list-item')) target.parentElement.remove();
                if (target.id === 'add-itinerary-item-btn') { document.getElementById('itinerary-list').insertAdjacentHTML('beforeend', `<div class="p-3 bg-gray-100 rounded-md mb-2"><div class="flex justify-between items-center mb-2"><p class="font-semibold">New Day</p><button type="button" class="remove-itinerary-item-btn text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div><input type="text" data-field="title" class="w-full p-2 border rounded-md mb-2 itinerary-input" placeholder="Day Title"><textarea data-field="description" class="w-full p-2 border rounded-md itinerary-input" rows="2" placeholder="Day Description"></textarea></div>`); lucide.createIcons(); document.querySelectorAll('#itinerary-list .font-semibold').forEach((dayLabel, i) => dayLabel.textContent = `Day ${i + 1}`); }
                if (target.classList.contains('remove-itinerary-item-btn')) { target.closest('.p-3').remove(); document.querySelectorAll('#itinerary-list .font-semibold').forEach((dayLabel, i) => dayLabel.textContent = `Day ${i + 1}`); }
                if (target.id === 'save-program-btn') { const { progIndex } = target.dataset; const isEditing = progIndex && progIndex !== ''; const title = document.getElementById('program-title').value; if (!title) return showToast('Program Title is required.', 'error'); const newDetailedPricing = Array.from(document.querySelectorAll('.pricing-tier-group')).map(tierGroup => { const pax = tierGroup.querySelector('input[data-field="pax"]').value; const costs = {}; tierGroup.querySelectorAll('input[data-cost-key], select[data-cost-key]').forEach(input => { const key = input.dataset.costKey; const field = input.dataset.field; if(!costs[key]) costs[key] = {}; costs[key][field] = (input.type === 'number') ? parseFloat(input.value) || 0 : input.value; }); const entranceTickets = Array.from(tierGroup.querySelectorAll('.ticket-row')).map(row => ({ id: `t_${Date.now()}_${Math.random()}`, name: row.querySelector('input[data-field="name"]').value, cost: parseFloat(row.querySelector('input[data-field="cost"]').value) || 0, currency: row.querySelector('select[data-field="currency"]').value })); return { pax, costs, entranceTickets }; }); const newProgram = { id: isEditing ? appData.programs[progIndex].id : `prog_${Date.now()}`, title, description: document.getElementById('program-description').value, detailedPricing: newDetailedPricing, itinerary: Array.from(document.querySelectorAll('#itinerary-list > div')).map((div, i) => ({ day: i + 1, title: div.querySelector('.itinerary-input[data-field="title"]').value, description: div.querySelector('.itinerary-input[data-field="description"]').value })), includes: Array.from(document.querySelectorAll('[data-list="includes"]')).map(i => i.value).filter(Boolean), excludes: Array.from(document.querySelectorAll('[data-list="excludes"]')).map(i => i.value).filter(Boolean), }; if (isEditing) appData.programs[progIndex] = newProgram; else { if (!appData.programs) appData.programs = []; appData.programs.push(newProgram); } renderAdminPrograms(); closeModal(); }
                if (target.classList.contains('add-program-to-trip-btn')) { const { progId } = target.dataset; const program = appData.programs.find(p => p.id === progId); if (!program) return; const newPackage = { id: `trip_${Date.now()}`, programId: progId, paxTier: '', startDate: '', accommodations: [], individualItems: {} }; currentTrip.packages.push(newPackage); renderCalculatorPanel(); }
                if (target.classList.contains('remove-package-from-trip-btn')) { currentTrip.packages.splice(target.dataset.pkgIndex, 1); renderCalculatorPanel(); }
                if (target.classList.contains('add-hotel-leg-btn')) { const { pkgIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations.push({ type: 'hotel', cityId: '', hotelId: '', roomId: '', viewId: '', nights: 1, checkIn: '', checkOut: '' }); renderCalculatorPanel(); }
                if (target.classList.contains('add-cruise-leg-btn')) { const { pkgIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations.push({ type: 'cruise', nights: 1, cruiseLineId: '', cruiseId: '', roomId: '', checkIn: '', checkOut: '' }); renderCalculatorPanel(); }
                if (target.classList.contains('remove-accommodation-leg-btn')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations.splice(accIndex, 1); renderCalculatorPanel(); }
                if (target.classList.contains('add-individual-to-pkg-btn')) { const { pkgIndex, category } = target.dataset; const container = target.closest('.flex'); const select = container.querySelector('.individual-service-select'); const quantityInput = container.querySelector('.individual-quantity-input'); const serviceId = select.value; const quantity = parseInt(quantityInput.value); if (serviceId && quantity > 0) { const pkg = currentTrip.packages[pkgIndex]; if (!pkg.individualItems[category]) pkg.individualItems[category] = []; pkg.individualItems[category].push({ serviceId, quantity }); renderCalculatorPanel(); } else { showToast('Please select an item and quantity.', 'error'); } }
                if (target.classList.contains('remove-individual-from-pkg-btn')) { const { pkgIndex, category, itemIndex } = target.dataset; currentTrip.packages[pkgIndex].individualItems[category].splice(itemIndex, 1); renderCalculatorPanel(); }
                if (target.classList.contains('preview-program-btn')) { openProgramDetailsModal(target.dataset.progIndex); }
                 if(target.classList.contains('view-package-details-btn')) { openDetailedPricingModal(currentTrip.packages[target.dataset.pkgIndex]); }
                if (target.id === 'close-modal-btn') closeModal();
            });
            document.body.addEventListener('change', e => {
                const target = e.target;
                if (target.matches('.trip-pax-select')) { const { pkgIndex } = target.dataset; currentTrip.packages[pkgIndex].paxTier = target.value; renderCalculatorPanel(); }
                if (target.matches('.trip-city-select')) { const { pkgIndex, accIndex } = target.dataset; const acc = currentTrip.packages[pkgIndex].accommodations[accIndex]; acc.cityId = target.value; acc.hotelId = ''; acc.roomId = ''; acc.viewId = ''; renderCalculatorPanel(); }
                if (target.matches('.trip-hotel-select')) { const { pkgIndex, accIndex } = target.dataset; const acc = currentTrip.packages[pkgIndex].accommodations[accIndex]; acc.hotelId = target.value; acc.roomId = ''; acc.viewId = ''; renderCalculatorPanel(); }
                if (target.matches('.trip-room-select')) { const { pkgIndex, accIndex } = target.dataset; const acc = currentTrip.packages[pkgIndex].accommodations[accIndex]; acc.roomId = target.value; acc.viewId = ''; renderCalculatorPanel(); }
                if (target.matches('.trip-view-select')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations[accIndex].viewId = target.value; renderCalculatorPanel(); }
                if (target.matches('.trip-cruiseline-select')) { const { pkgIndex, accIndex } = target.dataset; const acc = currentTrip.packages[pkgIndex].accommodations[accIndex]; acc.cruiseLineId = target.value; acc.cruiseId = ''; acc.roomId = ''; renderCalculatorPanel(); }
                if (target.matches('.trip-cruise-select')) { const { pkgIndex, accIndex } = target.dataset; const acc = currentTrip.packages[pkgIndex].accommodations[accIndex]; acc.cruiseId = target.value; acc.roomId = ''; renderCalculatorPanel(); }
                if (target.matches('.trip-cruiseroom-select')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations[accIndex].roomId = target.value; renderCalculatorPanel(); }
            });
            document.body.addEventListener('input', e => {
                const target = e.target;
                if (target.matches('#exchange-rate-input')) { appData.exchangeRate = parseFloat(target.value) || 0; }
                if (target.matches('.trip-start-date-input')) { const { pkgIndex } = target.dataset; currentTrip.packages[pkgIndex].startDate = target.value; }
                if (target.matches('.admin-service-input')) { const { category, index, field } = target.dataset; let value = target.value; if (target.type === 'number') value = parseFloat(value) || 0; appData.services[category][index][field] = value; }
                if (target.matches('.trip-nights-input')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations[accIndex].nights = parseInt(target.value) || 0; renderCalculatorPanel(); }
                if (target.matches('.trip-checkin-input')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations[accIndex].checkIn = target.value; }
                if (target.matches('.trip-checkout-input')) { const { pkgIndex, accIndex } = target.dataset; currentTrip.packages[pkgIndex].accommodations[accIndex].checkOut = target.value; }
            });
        };

        // --- INITIALIZATION ---
        const initializeApp = () => {
            loader = document.getElementById('loader'); appContainer = document.getElementById('app-container'); adminPanel = document.getElementById('admin-panel'); calculatorPanel = document.getElementById('calculator-panel'); headerTitle = document.getElementById('header-title'); accountBtn = document.getElementById('account-btn'); modalBackdrop = document.getElementById('modal-backdrop'); modalContent = document.getElementById('modal-content');
            appData = loadData();
            updateDashboardUI();
            initListeners();
            updateChannel.onmessage = (event) => {
                if (event.data === 'data_updated') {
                    showToast('Data has been updated in another tab!', 'info');
                    appData = loadData();
                    currentTrip = { packages: [] };
                    updateDashboardUI();
                }
            };
            loader.style.display = 'none';
            appContainer.classList.remove('hidden');
        };
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>

